# Regras de C√°lculo de Comiss√£o do Corretor

## REGRA FUNDAMENTAL

A comiss√£o do corretor √© calculada **SEMPRE** baseada nos **PAGAMENTOS** (tabela `pagamentos_prosoluto`), **NUNCA** baseado no status da venda.

---

## ‚ùå O QUE NUNCA FAZER

```javascript
// ERRADO ‚ùå - N√£o use o status da venda!
const comissaoPaga = vendas
  .filter(v => v.status === 'pago')
  .reduce((acc, v) => acc + v.comissao_corretor, 0)

// ERRADO ‚ùå - N√£o some comissao_corretor direto da venda!
const totalComissao = vendas.reduce((acc, v) => acc + v.comissao_corretor, 0)
```

---

## ‚úÖ O QUE SEMPRE FAZER

```javascript
// CORRETO ‚úÖ - Use os pagamentos individuais!
const comissaoPaga = meusPagamentos
  .filter(pag => pag.status === 'pago')
  .reduce((acc, pag) => acc + calcularComissaoPagamento(pag), 0)

const comissaoPendente = meusPagamentos
  .filter(pag => pag.status === 'pendente')
  .reduce((acc, pag) => acc + calcularComissaoPagamento(pag), 0)

const totalComissao = meusPagamentos
  .reduce((acc, pag) => acc + calcularComissaoPagamento(pag), 0)
```

---

## üìä F√ìRMULA DE COMISS√ÉO POR PAGAMENTO

```javascript
const calcularComissaoPagamento = (pagamento) => {
  // 1. Usar comissao_gerada se existir
  if (pagamento.comissao_gerada > 0) {
    return pagamento.comissao_gerada
  }
  
  // 2. Usar fator_comissao_corretor se existir
  if (pagamento.fator_comissao_corretor > 0) {
    return pagamento.valor * pagamento.fator_comissao_corretor
  }
  
  // 3. Calcular baseado na venda
  const venda = vendas.find(v => v.id === pagamento.venda_id)
  if (venda?.fator_comissao_corretor > 0) {
    return pagamento.valor * venda.fator_comissao_corretor
  }
  
  // 4. Fallback: propor√ß√£o simples
  if (venda?.comissao_corretor && venda?.valor_pro_soluto > 0) {
    const fator = venda.comissao_corretor / venda.valor_pro_soluto
    return pagamento.valor * fator
  }
  
  // 5. √öltimo fallback: percentual padr√£o
  return pagamento.valor * (percentualCorretor / 100)
}
```

---

## üìç ONDE APLICAR

| Local | Descri√ß√£o |
|-------|-----------|
| Dashboard | Cards de resumo (Total, Pago, Pendente) |
| Minhas Vendas | Resumo de comiss√µes filtradas |
| Meus Pagamentos | Resumo de pagamentos |
| Relat√≥rios | Resumo geral e por empreendimento |
| PDF | Gera√ß√£o de relat√≥rio PDF |

---

## üéØ POR QUE ISSO √â IMPORTANTE

1. Uma venda pode ter **m√∫ltiplos pagamentos** com status diferentes
2. O corretor recebe **por parcela paga**, n√£o por venda fechada
3. O `venda.status` n√£o reflete a realidade dos pagamentos individuais
4. A comiss√£o real √© a soma das **parcelas pagas**

---

## üìã EXEMPLO PR√ÅTICO

**Venda:** R$ 300.000,00 com 10 parcelas de R$ 6.000,00 cada (pro-soluto R$ 60.000,00)

**Comiss√£o total do corretor:** R$ 12.000,00 (4%)

**Situa√ß√£o atual:**
- 3 parcelas pagas (status: 'pago')
- 7 parcelas pendentes (status: 'pendente')

**C√°lculo CORRETO:**
- Comiss√£o Paga: 3 √ó (R$ 6.000 √ó fator) = R$ 3.600,00
- Comiss√£o Pendente: 7 √ó (R$ 6.000 √ó fator) = R$ 8.400,00

**C√°lculo ERRADO (baseado na venda):**
- Se venda.status = 'pendente': Comiss√£o Paga = R$ 0,00 ‚Üê ERRADO!
- Deveria mostrar os R$ 3.600,00 j√° pagos
